<!doctype html><html lang=zh-Hans-CN><head><title>modao's blog</title><meta content="text/html; charset=utf-8" http-equiv=content-type><meta content="width=device-width,initial-scale=1.0,maximum-scale=1" name=viewport><meta content=noodp name=robots><link href=https://modao.site/style.css rel=stylesheet><link href=https://modao.site/color/green.css rel=stylesheet><link href=https://modao.site/color/background_dark.css rel=stylesheet><link href=https://modao.site/font-hack.css rel=stylesheet><body><div class=container><header class=header><div class=header__inner><div class=header__logo><a style="text-decoration: none;" href=https://modao.site> <div class=logo>MODAO</div> </a></div></div><nav class=menu><ul class=menu__inner><li class=active><a href=https://modao.site>Home</a><li><a href=https://modao.site/tags>Tags</a><li><a href=https://modao.site/links>Links</a><li><a href=https://modao.site/friend>Friend</a><li><a href=https://modao.site/about>About Me</a></ul></nav></header><div class=content><div class=post><h1 class=post-title><a href=https://modao.site/C++/urlbian-ma-jie-ma/>URL编码解码</a></h1><div class=post-meta-inline><span class=post-date> 2021-04-01 </span></div><span class=post-tags-inline> :: tags:  <a class=post-tag href=https://modao.site/tags/cpp/>#cpp</a></span><div class=post-content><p>URL中文问题<h2 id=urlbian-ma-yuan-li>URL编码原理</h2><p>网页URL的合法字符分成两类：<ul><li><p>URL元字符：分号（;），逗号（,），斜杠（/），问号（?），冒号（:），at（@），&，等号（=），加号（+），美元符号（$），井号（#）</p><li><p>语义字符：a-z，A-Z，0-9，连词号（-），下划线（_），点（.），感叹号（!），波浪线（~），星号（*），单引号（），圆括号（()）</p></ul><p>除了以上字符，其他字符出现在URL之中都<strong>必须转义</strong>，规则是<strong>根据操作系统的默认编码</strong>，将每个字节转为百分号（%）加上两个大写的十六进制字母，这些不是什么乱码，而是UTF-8编码或者gbk(GB2312)编码，那些百分号（%）后面的数字和字母其实就是16进制数。<ul><li><p>如果是中文的gbk(GB2312)编码，那么它的形式应该是这样的，即一个汉字对应两组%xx，即%xx%xx</p><li><p>如果是中文的UTF-8编码，那么它的形式应该是这样的，即一个汉字对应三组%xx，即%xx%xx%xx</p></ul><blockquote><p>为什么要使用这样的编码？ 这是为了兼容一些设备，有些设备只能传ASCII码，只认识128个字符，不认识汉字。</blockquote><h2 id=c-bian-ma-jie-ma-shi-xian>C++编码解码实现</h2><p>C++使用GBK编码<p>绝对不编码的，只有字母、数字、短横线(-)、下划线(_)、点(.)和波浪号(~)，其他字符要视情况而定<pre class=language-cpp data-lang=cpp style=background-color:#2b303b;color:#c0c5ce;><code class=language-cpp data-lang=cpp><span style=color:#b48ead;>unsigned char </span><span style=color:#8fa1b3;>ToHex</span><span>(</span><span style=color:#b48ead;>unsigned char </span><span style=color:#bf616a;>x</span><span>) 
</span><span>{ 
</span><span>    </span><span style=color:#b48ead;>return</span><span>  x > </span><span style=color:#d08770;>9 </span><span>? x + </span><span style=color:#d08770;>55 </span><span>: x + </span><span style=color:#d08770;>48</span><span>; 
</span><span>}
</span><span> 
</span><span style=color:#b48ead;>unsigned char </span><span style=color:#8fa1b3;>FromHex</span><span>(</span><span style=color:#b48ead;>unsigned char </span><span style=color:#bf616a;>x</span><span>) 
</span><span>{ 
</span><span>    </span><span style=color:#b48ead;>unsigned char</span><span> y;
</span><span>    </span><span style=color:#b48ead;>if </span><span>(x >= '</span><span style=color:#a3be8c;>A</span><span>' && x <= '</span><span style=color:#a3be8c;>Z</span><span>') y = x - '</span><span style=color:#a3be8c;>A</span><span>' + </span><span style=color:#d08770;>10</span><span>;
</span><span>    </span><span style=color:#b48ead;>else if </span><span>(x >= '</span><span style=color:#a3be8c;>a</span><span>' && x <= '</span><span style=color:#a3be8c;>z</span><span>') y = x - '</span><span style=color:#a3be8c;>a</span><span>' + </span><span style=color:#d08770;>10</span><span>;
</span><span>    </span><span style=color:#b48ead;>else if </span><span>(x >= '</span><span style=color:#a3be8c;>0</span><span>' && x <= '</span><span style=color:#a3be8c;>9</span><span>') y = x - '</span><span style=color:#a3be8c;>0</span><span>';
</span><span>    </span><span style=color:#b48ead;>else </span><span style=color:#96b5b4;>assert</span><span>(</span><span style=color:#d08770;>0</span><span>);
</span><span>    </span><span style=color:#b48ead;>return</span><span> y;
</span><span>}
</span><span> 
</span><span>std::string </span><span style=color:#8fa1b3;>UrlEncode</span><span>(</span><span style=color:#b48ead;>const</span><span> std::string& </span><span style=color:#bf616a;>str</span><span>)
</span><span>{
</span><span>    std::string strTemp = "";
</span><span>    size_t length = str.</span><span style=color:#bf616a;>length</span><span>();
</span><span>    </span><span style=color:#b48ead;>for </span><span>(size_t i = </span><span style=color:#d08770;>0</span><span>; i < length; i++)
</span><span>    {
</span><span>        </span><span style=color:#b48ead;>if </span><span>(</span><span style=color:#96b5b4;>isalnum</span><span>((</span><span style=color:#b48ead;>unsigned char</span><span>)str[i]) || 
</span><span>            (str[i] == '</span><span style=color:#a3be8c;>-</span><span>') ||
</span><span>            (str[i] == '</span><span style=color:#a3be8c;>_</span><span>') || 
</span><span>            (str[i] == '</span><span style=color:#a3be8c;>.</span><span>') || 
</span><span>            (str[i] == '</span><span style=color:#a3be8c;>~</span><span>'))
</span><span>            strTemp += str[i];
</span><span>        </span><span style=color:#b48ead;>else if </span><span>(str[i] == ' ')
</span><span>            strTemp += "</span><span style=color:#a3be8c;>+</span><span>";
</span><span>        </span><span style=color:#b48ead;>else
</span><span>        {
</span><span>            strTemp += '</span><span style=color:#a3be8c;>%</span><span>';
</span><span>            strTemp += </span><span style=color:#bf616a;>ToHex</span><span>((</span><span style=color:#b48ead;>unsigned char</span><span>)str[i] >> </span><span style=color:#d08770;>4</span><span>);</span><span style=color:#65737e;>//高4位
</span><span>            strTemp += </span><span style=color:#bf616a;>ToHex</span><span>((</span><span style=color:#b48ead;>unsigned char</span><span>)str[i] % </span><span style=color:#d08770;>16</span><span>);</span><span style=color:#65737e;>//低4w
</span><span>        }
</span><span>    }
</span><span>    </span><span style=color:#b48ead;>return</span><span> strTemp;
</span><span>}
</span><span> 
</span><span>std::string </span><span style=color:#8fa1b3;>UrlDecode</span><span>(</span><span style=color:#b48ead;>const</span><span> std::string& </span><span style=color:#bf616a;>str</span><span>)
</span><span>{
</span><span>    std::string strTemp = "";
</span><span>    size_t length = str.</span><span style=color:#bf616a;>length</span><span>();
</span><span>    </span><span style=color:#b48ead;>for </span><span>(size_t i = </span><span style=color:#d08770;>0</span><span>; i < length; i++)
</span><span>    {
</span><span>        </span><span style=color:#b48ead;>if </span><span>(str[i] == '</span><span style=color:#a3be8c;>+</span><span>') strTemp += ' ';
</span><span>        </span><span style=color:#b48ead;>else if </span><span>(str[i] == '</span><span style=color:#a3be8c;>%</span><span>')
</span><span>        {
</span><span>            </span><span style=color:#96b5b4;>assert</span><span>(i + </span><span style=color:#d08770;>2 </span><span>< length);
</span><span>            </span><span style=color:#b48ead;>unsigned char</span><span> high = </span><span style=color:#bf616a;>FromHex</span><span>((</span><span style=color:#b48ead;>unsigned char</span><span>)str[++i]);
</span><span>            </span><span style=color:#b48ead;>unsigned char</span><span> low = </span><span style=color:#bf616a;>FromHex</span><span>((</span><span style=color:#b48ead;>unsigned char</span><span>)str[++i]);
</span><span>            strTemp += high*</span><span style=color:#d08770;>16 </span><span>+ low;
</span><span>        }
</span><span>        </span><span style=color:#b48ead;>else</span><span> strTemp += str[i];
</span><span>    }
</span><span>    </span><span style=color:#b48ead;>return</span><span> strTemp;
</span><span>}
</span></code></pre><h2 id=can-kao-wen-zhang>参考文章</h2><ul><li><p><a href=https://www.douban.com/note/209548174/>含有中文的网址中显示百分号%、十六进制数字等“乱码”是什么?</a></p><li><p><a href=https://segmentfault.com/a/1190000011268085>URL传递中文编码的解决方案</a></p><li><p><a href=http://www.voidcn.com/article/p-yurfrgwa-bpu.html>C++ Http请求中文传参乱码问题</a></p></ul></div></div></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2022 modao</span><span class=copyright-theme> <span class=copyright-theme-sep>:: </span> Theme: <a href=https://github.com/pawroman/zola-theme-terminimal/>Terminimal</a> by pawroman </span></div></div></footer></div>