<!doctype html><html lang=zh-Hans-CN><head><title>modao's blog</title><meta content="text/html; charset=utf-8" http-equiv=content-type><meta content="width=device-width,initial-scale=1.0,maximum-scale=1" name=viewport><meta content=noodp name=robots><link href=https://modao.site/style.css rel=stylesheet><link href=https://modao.site/color/green.css rel=stylesheet><link href=https://modao.site/color/background_dark.css rel=stylesheet><link href=https://modao.site/font-hack.css rel=stylesheet><body><div class=container><header class=header><div class=header__inner><div class=header__logo><a style="text-decoration: none;" href=https://modao.site> <div class=logo>MODAO</div> </a></div></div><nav class=menu><ul class=menu__inner><li class=active><a href=https://modao.site>Home</a><li><a href=https://modao.site/tags>Tags</a><li><a href=https://modao.site/language>Programming-Language</a><li><a href=https://modao.site/books>Books</a><li><a href=https://modao.site/links>Links</a><li><a href=https://modao.site/friend>Friend</a><li><a href=https://modao.site/about>About Me</a></ul></nav></header><div class=content><div class=post><h1 class=post-title><a href=https://modao.site/编程语言/Python/pythonpa-chong-tong-yong-de-retyrku-tenacityku/>python爬虫——一个通用的retry库：Tenacity</a></h1><div class=post-meta-inline><span class=post-date> 2019-10-10 </span></div><div class=post-content><p>一个健壮的爬虫程序需要捕获并处理程序在运行过程中的异常，其中网络连接相关的错误是很令人烦恼的，出现网络连接问题的原因是多样的，很多时候无法明确判断是不是程序真的无法执行下去了，从而重试操作是最先考虑的方法。Tenacity库提供重试装饰器，很是方便。<p><strong><a href=https://www.cnblogs.com/thomaszdxsn/p/amadtenacity--python-zhong-yi-ge-zhuan-men-yong-la.html>原文链接</a></strong><h2 id=jian-jie>简介</h2><p><code>Tenacity</code><sup><a href=https://www.cnblogs.com/thomaszdxsn/p/amadtenacity--python-zhong-yi-ge-zhuan-men-yong-la.html#fn1>1</a></sup>是一个通用的retry库，简化为任何任务加入重试的功能。<p>它还包含如下特性:<ul><li>通用的装饰器API<li>可以设定重试停止的条件（比如设定尝试次数）<li>可以设定重试间的等待时间（比如在尝试之间使用幂数级增长的wait等待）<li>自定义在哪些Exception进行重试<li>自定义在哪些返回值的情况进行重试<li>协程的重试</ul><h2 id=yong-fa>用法</h2><ol><li><p>简单用法</p> <pre class=language-python data-lang=python style=background-color:#2b303b;color:#c0c5ce;><code class=language-python data-lang=python><span style=color:#b48ead;>from </span><span>tenacity </span><span style=color:#b48ead;>import </span><span style=color:#d08770;>*
</span><span>
</span><span style=color:#65737e;># 基础的用法，会一直重试下去，直到函数没有抛出异常，正常返回值
</span><span>@</span><span style=color:#bf616a;>retry
</span><span style=color:#b48ead;>def </span><span style=color:#8fa1b3;>never_give_up_never_surrender</span><span>():
</span><span>    </span><span style=color:#96b5b4;>print</span><span>("</span><span style=color:#a3be8c;>一直重试，忽略exceptions，重试间没有等待时间</span><span>")
</span><span>    </span><span style=color:#b48ead;>raise </span><span>Exception
</span></code></pre><li><p>设置停止条件</p> <p>在达到尝试次数后停下来:</p> <pre class=language-python data-lang=python style=background-color:#2b303b;color:#c0c5ce;><code class=language-python data-lang=python><span>@</span><span style=color:#bf616a;>retry</span><span>(</span><span style=color:#bf616a;>stop</span><span>=</span><span style=color:#bf616a;>stop_after_attempt</span><span>(</span><span style=color:#d08770;>7</span><span>))
</span><span style=color:#b48ead;>def </span><span style=color:#8fa1b3;>stop_after_7_attempts</span><span>():
</span><span>    </span><span style=color:#96b5b4;>print</span><span>("</span><span style=color:#a3be8c;>尝试7次后停下</span><span>")
</span><span>    </span><span style=color:#b48ead;>raise </span><span>Exception
</span></code></pre> <p>10秒后仍然没有成功则停下:</p> <pre class=language-python data-lang=python style=background-color:#2b303b;color:#c0c5ce;><code class=language-python data-lang=python><span>@</span><span style=color:#bf616a;>retry</span><span>(</span><span style=color:#bf616a;>stop</span><span>=</span><span style=color:#bf616a;>stop_after_delay</span><span>(</span><span style=color:#d08770;>10</span><span>))
</span><span style=color:#b48ead;>def </span><span style=color:#8fa1b3;>stop_after_10_s</span><span>():
</span><span>    </span><span style=color:#96b5b4;>print</span><span>("</span><span style=color:#a3be8c;>10秒后停止</span><span>")
</span><span>    </span><span style=color:#b48ead;>raise </span><span>Exception
</span></code></pre> <p>使用|操作符组合多种条件:</p> <pre class=language-python data-lang=python style=background-color:#2b303b;color:#c0c5ce;><code class=language-python data-lang=python><span>@</span><span style=color:#bf616a;>retry</span><span>(</span><span style=color:#bf616a;>stop</span><span>=(</span><span style=color:#bf616a;>stop_after_delay</span><span>(</span><span style=color:#d08770;>10</span><span>) | </span><span style=color:#bf616a;>stop_after_attempt</span><span>(</span><span style=color:#d08770;>5</span><span>)))
</span><span style=color:#b48ead;>def </span><span style=color:#8fa1b3;>stop_after_10_s_or_5_retries</span><span>():
</span><span>    </span><span style=color:#96b5b4;>print</span><span>("</span><span style=color:#a3be8c;>10秒后，或者尝试5次后，停下来</span><span>")
</span><span>    </span><span style=color:#b48ead;>raise </span><span>Exception
</span></code></pre><li><p>设置重试间隔</p> <pre class=language-python data-lang=python style=background-color:#2b303b;color:#c0c5ce;><code class=language-python data-lang=python><span>@</span><span style=color:#bf616a;>retry</span><span>(</span><span style=color:#bf616a;>wait</span><span>=</span><span style=color:#bf616a;>wait_fixed</span><span>(</span><span style=color:#d08770;>2</span><span>))
</span><span style=color:#b48ead;>def </span><span style=color:#8fa1b3;>wait_2_s</span><span>():
</span><span>    </span><span style=color:#96b5b4;>print</span><span>("</span><span style=color:#a3be8c;>每次重试间都有2秒间隔</span><span>")
</span><span>    </span><span style=color:#b48ead;>raise </span><span>Exception
</span></code></pre> <p>随机间隔时间:</p> <pre class=language-python data-lang=python style=background-color:#2b303b;color:#c0c5ce;><code class=language-python data-lang=python><span>@</span><span style=color:#bf616a;>retry</span><span>(</span><span style=color:#bf616a;>wait</span><span>=</span><span style=color:#bf616a;>wait_random</span><span>(</span><span style=color:#bf616a;>min</span><span>=</span><span style=color:#d08770;>1</span><span>, </span><span style=color:#bf616a;>max</span><span>=</span><span style=color:#d08770;>2</span><span>))
</span><span style=color:#b48ead;>def </span><span style=color:#8fa1b3;>wait_random_1_to_2_s</span><span>():
</span><span>    </span><span style=color:#96b5b4;>print</span><span>("</span><span style=color:#a3be8c;>重试间隔1-2秒</span><span>")
</span><span>    </span><span style=color:#b48ead;>raise </span><span>Exception
</span></code></pre> <p>指数曲线间隔时间:</p> <pre class=language-python data-lang=python style=background-color:#2b303b;color:#c0c5ce;><code class=language-python data-lang=python><span>@</span><span style=color:#bf616a;>retry</span><span>(</span><span style=color:#bf616a;>wait</span><span>=</span><span style=color:#bf616a;>wait_exponential</span><span>(</span><span style=color:#bf616a;>multiplier</span><span>=</span><span style=color:#d08770;>1</span><span>, </span><span style=color:#bf616a;>min</span><span>=</span><span style=color:#d08770;>4</span><span>, </span><span style=color:#bf616a;>max</span><span>=</span><span style=color:#d08770;>10</span><span>))
</span><span style=color:#b48ead;>def </span><span style=color:#8fa1b3;>wait_exponential_1</span><span>():
</span><span>    </span><span style=color:#96b5b4;>print</span><span>("</span><span style=color:#a3be8c;>开始的时候等待 2^x * 1 秒，最少等待4秒，最多10秒，之后都是等待10秒</span><span>")
</span><span>    </span><span style=color:#b48ead;>raise </span><span>Exception
</span></code></pre> <p>指数间隔时间：</p> <p>多核在竞争一个共享的资源，使用指数间隔可以将冲突最小化</p> <pre class=language-python data-lang=python style=background-color:#2b303b;color:#c0c5ce;><code class=language-python data-lang=python><span>@</span><span style=color:#bf616a;>retry</span><span>(</span><span style=color:#bf616a;>wait</span><span>=</span><span style=color:#bf616a;>wait_random_exponential</span><span>(</span><span style=color:#bf616a;>multiplier</span><span>=</span><span style=color:#d08770;>1</span><span>, </span><span style=color:#bf616a;>max</span><span>=</span><span style=color:#d08770;>60</span><span>))
</span><span style=color:#b48ead;>def </span><span style=color:#8fa1b3;>wait_exponential_jitter</span><span>():
</span><span>    </span><span style=color:#96b5b4;>print</span><span>("</span><span style=color:#a3be8c;>随机等待 2^x * 1 秒，最多60秒，之后都是等待60秒</span><span>")
</span><span>    </span><span style=color:#b48ead;>raise </span><span>Exception
</span></code></pre> <p>可以自定义每次等待时长:</p> <pre class=language-python data-lang=python style=background-color:#2b303b;color:#c0c5ce;><code class=language-python data-lang=python><span>```
</span><span>@</span><span style=color:#bf616a;>retry</span><span>(</span><span style=color:#bf616a;>wait</span><span>=</span><span style=color:#bf616a;>wait_chain</span><span>(*[</span><span style=color:#bf616a;>wait_fixed</span><span>(</span><span style=color:#d08770;>3</span><span>) </span><span style=color:#b48ead;>for </span><span>i </span><span style=color:#b48ead;>in </span><span style=color:#96b5b4;>range</span><span>(</span><span style=color:#d08770;>3</span><span>)] +
</span><span>                           [</span><span style=color:#bf616a;>wait_fixed</span><span>(</span><span style=color:#d08770;>7</span><span>) </span><span style=color:#b48ead;>for </span><span>i </span><span style=color:#b48ead;>in </span><span style=color:#96b5b4;>range</span><span>(</span><span style=color:#d08770;>2</span><span>)] +
</span><span>                           [</span><span style=color:#bf616a;>wait_fixed</span><span>(</span><span style=color:#d08770;>9</span><span>)]))
</span><span style=color:#b48ead;>def </span><span style=color:#8fa1b3;>wait_fixed_chained</span><span>():
</span><span>    </span><span style=color:#96b5b4;>print</span><span>("</span><span style=color:#a3be8c;>前三次等待3秒，后两次等待7秒，最后一次等待9秒</span><span>")
</span><span>    </span><span style=color:#b48ead;>raise </span><span>Exception
</span><span>```
</span></code></pre><li><p>设置retry条件</p> <p>默认情况下，只有函数抛出异常时才会retry。</p> <p>可以设置在制定的异常才进行retry：</p> <pre class=language-python data-lang=python style=background-color:#2b303b;color:#c0c5ce;><code class=language-python data-lang=python><span>@</span><span style=color:#bf616a;>retry</span><span>(</span><span style=color:#bf616a;>retry</span><span>=</span><span style=color:#bf616a;>retry_if_exception_type</span><span>(IOError))
</span><span style=color:#b48ead;>def </span><span style=color:#8fa1b3;>might_io_error</span><span>():
</span><span>    </span><span style=color:#96b5b4;>print</span><span>("</span><span style=color:#a3be8c;>只有在IOError的时候进行retry，其它时候照常抛出错误</span><span>")
</span><span>    </span><span style=color:#b48ead;>raise </span><span>Exception
</span></code></pre> <p>可以在判断返回值是否是需要的情况下进行retry：</p> <pre class=language-python data-lang=python style=background-color:#2b303b;color:#c0c5ce;><code class=language-python data-lang=python><span style=color:#b48ead;>def </span><span style=color:#8fa1b3;>is_none_p</span><span>(</span><span style=color:#bf616a;>value</span><span>):
</span><span>        </span><span style=color:#b48ead;>return </span><span>value is </span><span style=color:#d08770;>None
</span><span>
</span><span>@</span><span style=color:#bf616a;>retry</span><span>(</span><span style=color:#bf616a;>retry</span><span>=</span><span style=color:#bf616a;>retry_if_result</span><span>(is_none_p))
</span><span style=color:#b48ead;>def </span><span style=color:#8fa1b3;>might_return_none</span><span>():
</span><span>    </span><span style=color:#96b5b4;>print</span><span>("</span><span style=color:#a3be8c;>因为返回值是None，所以这个函数会一直retry</span><span>")
</span><span>        
</span><span style=color:#65737e;># 这样写也是可以的，不用修改原来的代码
</span><span>retry_version_func = </span><span style=color:#bf616a;>retry</span><span>(</span><span style=color:#bf616a;>retry</span><span>=</span><span style=color:#bf616a;>retry_if_result</span><span>(is_none_p))(might_return_none)    
</span></code></pre> <p>组合多个条件:</p> <pre class=language-python data-lang=python style=background-color:#2b303b;color:#c0c5ce;><code class=language-python data-lang=python><span style=color:#b48ead;>def </span><span style=color:#8fa1b3;>is_none_p</span><span>(</span><span style=color:#bf616a;>value</span><span>):
</span><span>    </span><span style=color:#b48ead;>return </span><span>value is </span><span style=color:#d08770;>None
</span><span>
</span><span>@</span><span style=color:#bf616a;>retry</span><span>(</span><span style=color:#bf616a;>retry</span><span>=(</span><span style=color:#bf616a;>retry_if_result</span><span>(is_none_p) | </span><span style=color:#bf616a;>retry_if_exception_type</span><span>()))
</span><span style=color:#b48ead;>def </span><span style=color:#8fa1b3;>might_return_none</span><span>():
</span><span>    </span><span style=color:#96b5b4;>print</span><span>("</span><span style=color:#a3be8c;>在抛出任何异常，或者返回值是None的情况下，进行retry</span><span>")
</span></code></pre></ol><h2 id=qi-ta>其他</h2><p>在函数体内，可以手动抛出TryAgain错误，然后进行重试:<pre class=language-python data-lang=python style=background-color:#2b303b;color:#c0c5ce;><code class=language-python data-lang=python><span>@</span><span style=color:#bf616a;>retry
</span><span style=color:#b48ead;>def </span><span style=color:#8fa1b3;>do_something</span><span>():
</span><span>   result = </span><span style=color:#bf616a;>something_else</span><span>()
</span><span>   </span><span style=color:#b48ead;>if </span><span>result == </span><span style=color:#d08770;>23</span><span>:
</span><span>      </span><span style=color:#b48ead;>raise </span><span>TryAgain
</span></code></pre><p>通过参数reraise=True，可以抛出函数最后一次抛出的异常。如果没有设定，会抛出RetryError:<pre class=language-python data-lang=python style=background-color:#2b303b;color:#c0c5ce;><code class=language-python data-lang=python><span>@</span><span style=color:#bf616a;>retry</span><span>(</span><span style=color:#bf616a;>reraise</span><span>=</span><span style=color:#d08770;>True</span><span>, </span><span style=color:#bf616a;>stop</span><span>=</span><span style=color:#bf616a;>stop_after_attempt</span><span>(</span><span style=color:#d08770;>3</span><span>))
</span><span style=color:#b48ead;>def </span><span style=color:#8fa1b3;>raise_my_exception</span><span>():
</span><span>    </span><span style=color:#b48ead;>raise </span><span style=color:#bf616a;>MyException</span><span>("</span><span style=color:#a3be8c;>Fail</span><span>")
</span><span>
</span><span style=color:#b48ead;>try</span><span>:
</span><span>    </span><span style=color:#bf616a;>raise_my_exception</span><span>()
</span><span style=color:#b48ead;>except </span><span>MyException:
</span><span>    </span><span style=color:#96b5b4;>print</span><span>('</span><span style=color:#a3be8c;>MyException会被抛出</span><span>')
</span></code></pre><p>在重试的前后，记录日志:<pre class=language-python data-lang=python style=background-color:#2b303b;color:#c0c5ce;><code class=language-python data-lang=python><span style=color:#b48ead;>import </span><span>logging
</span><span>
</span><span>logging.</span><span style=color:#bf616a;>basicConfig</span><span>(</span><span style=color:#bf616a;>stream</span><span>=sys.stderr, </span><span style=color:#bf616a;>level</span><span>=logging.</span><span style=color:#bf616a;>DEBUG</span><span>)
</span><span>
</span><span>logger = logging.</span><span style=color:#bf616a;>getLogger</span><span>(__name__)
</span><span>
</span><span style=color:#65737e;># 重试前记录
</span><span>@</span><span style=color:#bf616a;>retry</span><span>(</span><span style=color:#bf616a;>stop</span><span>=</span><span style=color:#bf616a;>stop_after_attempt</span><span>(</span><span style=color:#d08770;>3</span><span>), </span><span style=color:#bf616a;>before</span><span>=</span><span style=color:#bf616a;>before_log</span><span>(logger, logging.</span><span style=color:#bf616a;>DEBUG</span><span>))
</span><span style=color:#b48ead;>def </span><span style=color:#8fa1b3;>raise_my_exception</span><span>():
</span><span>    </span><span style=color:#b48ead;>raise </span><span style=color:#bf616a;>MyException</span><span>("</span><span style=color:#a3be8c;>Fail</span><span>")
</span><span>    
</span><span style=color:#65737e;># 重试后记录
</span><span>@</span><span style=color:#bf616a;>retry</span><span>(</span><span style=color:#bf616a;>stop</span><span>=</span><span style=color:#bf616a;>stop_after_attempt</span><span>(</span><span style=color:#d08770;>3</span><span>), </span><span style=color:#bf616a;>after</span><span>=</span><span style=color:#bf616a;>after_log</span><span>(logger, logging.</span><span style=color:#bf616a;>DEBUG</span><span>))
</span><span style=color:#b48ead;>def </span><span style=color:#8fa1b3;>raise_my_exception</span><span>():
</span><span>    </span><span style=color:#b48ead;>raise </span><span style=color:#bf616a;>MyException</span><span>("</span><span style=color:#a3be8c;>Fail</span><span>")
</span></code></pre><p>获取retry的相关统计数据:<pre class=language-python data-lang=python style=background-color:#2b303b;color:#c0c5ce;><code class=language-python data-lang=python><span>@</span><span style=color:#bf616a;>retry</span><span>(</span><span style=color:#bf616a;>stop</span><span>=</span><span style=color:#bf616a;>stop_after_attempt</span><span>(</span><span style=color:#d08770;>3</span><span>))
</span><span style=color:#b48ead;>def </span><span style=color:#8fa1b3;>raise_my_exception</span><span>():
</span><span>    </span><span style=color:#b48ead;>raise </span><span style=color:#bf616a;>MyException</span><span>("</span><span style=color:#a3be8c;>Fail</span><span>")
</span><span>
</span><span style=color:#b48ead;>try</span><span>:
</span><span>    </span><span style=color:#bf616a;>raise_my_exception</span><span>()
</span><span style=color:#b48ead;>except </span><span>Exception:
</span><span>    </span><span style=color:#b48ead;>pass
</span><span>
</span><span style=color:#96b5b4;>print</span><span>(raise_my_exception.retry.statistics)
</span></code></pre></div></div></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2022 modao</span><span class=copyright-theme> <span class=copyright-theme-sep>:: </span> Theme: <a href=https://github.com/pawroman/zola-theme-terminimal/>Terminimal</a> by pawroman </span></div></div></footer></div>