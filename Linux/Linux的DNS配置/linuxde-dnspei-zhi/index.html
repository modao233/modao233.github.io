<!doctype html><html lang=zh-Hans-CN><head><title>modao's blog</title><meta content="text/html; charset=utf-8" http-equiv=content-type><meta content="width=device-width,initial-scale=1.0,maximum-scale=1" name=viewport><meta content=noodp name=robots><link href=https://modao.site/style.css rel=stylesheet><link href=https://modao.site/color/green.css rel=stylesheet><link href=https://modao.site/color/background_dark.css rel=stylesheet><link href=https://modao.site/font-hack.css rel=stylesheet><script src="https://www.googletagmanager.com/gtag/js?id=G-N2WTGJE0M5" async></script><script>window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-N2WTGJE0M5');</script><body><div class=container><header class=header><div class=header__inner><div class=header__logo><a style="text-decoration: none;" href=https://modao.site> <div class=logo>MODAO</div> </a></div></div><nav class=menu><ul class=menu__inner><li class=active><a href=https://modao.site>Home</a><li><a href=https://modao.site/tags>Tags</a><li><a href=https://modao.site/language>PL</a><li><a href=https://modao.site/books>Books</a><li><a href=https://modao.site/links>Links</a><li><a href=https://modao.site/friend>Friend</a></ul></nav></header><div class=content><div class=post><h1 class=post-title><a href=https://modao.site/Linux/Linux的DNS配置/linuxde-dnspei-zhi/>Linux的DNS配置</a></h1><div class=post-meta-inline><span class=post-date> 2022-05-13 </span></div><span class=post-tags-inline> :: tags:  <a class=post-tag href=https://modao.site/tags/linux/>#Linux</a></span><div class=post-content><p>https://jvns.ca/blog/2022/02/23/getaddrinfo-is-kind-of-weird/ https://icloudnative.io/posts/resolvconf-tutorial DNS 的坑：<ul><li>ssh 中的 UseDNS<li>socket.getaddrinfo<li>libvirt 热迁移<li>时钟同步</ul><p>![image 20220614205335.png](Pasted image 20220614205335.png)<h2 id=getaddrinfohan-shu>getaddrinfo函数</h2><p>MacOS有DNS缓存，但Linux一般没有，除非使用<code>systemd-resolved</code> 等工具<p><code>getaddrinfo</code> 函数是C标准库 <code>libc</code> 的一部分，目前大概有三种libc，它们对<code>getaddrinfo</code>有不同的实现:<ol><li>glibc (GNU libc)<li>musl libc<li>the Mac OS version of libc (I don’t know if this has a name)</ol><p>Because <code>getaddrinfo</code> is so widely used, you’ll often see it in error messages related to DNS.<p>For example if I run this Python program which looks up nonexistent domain name:<pre style=background-color:#2b303b;color:#c0c5ce;><code><span>import requests
</span><span>
</span><span>requests.get("http://xyxqqx.com")
</span></code></pre><p>I get this error message:<pre style=background-color:#2b303b;color:#c0c5ce;><code><span>Traceback (most recent call last):
</span><span>  File "/usr/lib/python3.10/site-packages/urllib3/connection.py", line 174, in _new_conn
</span><span>    conn = connection.create_connection(
</span><span>  File "/usr/lib/python3.10/site-packages/urllib3/util/connection.py", line 72, in create_connection
</span><span>    for res in socket.getaddrinfo(host, port, family, socket.SOCK_STREAM):
</span><span>  File "/usr/lib/python3.10/socket.py", line 955, in getaddrinfo
</span><span>    for res in _socket.getaddrinfo(host, port, family, type, proto, flags):
</span><span>socket.gaierror: [Errno -2] Name or service not known
</span></code></pre><p>I think <code>socket.getaddrinfo</code> is calling libc <code>getaddrinfo</code> somewhere under the hood, though I did not read all of the source code to check.<p>Before you learn what <code>getaddrinfo</code> is, it’s not at all obvious that <code>socket.gaierror: [Errno -2] Name or service not known</code> means “that domain doesn’t exist”. It doesn’t even say the words “DNS” or “domain” in it anywhere!<h2 id=zhong-xin-duo-hui-dui-etc-resolv-conf-de-kong-zhi-quan>重新夺回对 /etc/resolv.conf 的控制权</h2><p>随着 Linux 的不断发展壮大，涌现出了各种各样的 DNS 自动管理程序，它们都想要直接获得 <code>/etc/resolv.conf</code> 的控制权，有些人欣然接受，有些人则无法接受。如果你是无法接受的那一方，那么请继续往下看，我会教你如何识别出是哪些程序在控制你的 <code>/etc/resolv.conf</code> 文件，以及如何夺回控制权。<p>目前能够控制 <code>/etc/resolv.conf</code> 文件的工具大概有这么几个：<code>netconfig</code>, <code>NetworkManager</code>, <code>resolvconf</code>, <code>rdnssd</code> 和 <code>systemd-resolved</code>。如果你的 <code>/etc/resolv.conf</code> 文件正在被它们控制，那么你对该文件的任何修改都会在几分钟后被覆盖，或者重启后被恢复成原来的值。<p>要想重新夺回对 <code>/etc/resolv.conf</code> 的控制权，首先就要识别出是谁在控制这个文件。<h2 id=1-zhao-chu-shi-shui-zai-kong-zhi-etc-resolv-conf>1. 找出是谁在控制 /etc/resolv.conf</h2><p>先尝试读取 <code>/etc/resolv.conf</code> 开头的注释，注释里一般会标明是谁在操控该文件：<pre class=language-bash data-lang=bash style=background-color:#2b303b;color:#c0c5ce;><code class=language-bash data-lang=bash><span style=color:#bf616a;>$</span><span> head /etc/resolv.conf
</span></code></pre><p>有些工具不会在 <code>/etc/resolv.conf</code> 文件中添加注释，从文件内容里找不到任何蛛丝马迹。这时我们需要换种方法，直接查看该文件是否是一个软链接：<pre class=language-bash data-lang=bash style=background-color:#2b303b;color:#c0c5ce;><code class=language-bash data-lang=bash><span style=color:#bf616a;>$</span><span> ls</span><span style=color:#bf616a;> -l</span><span> /etc/resolv.conf
</span></code></pre><p>如果还是找不到任何线索，那就只能查看系统运行的进程中是否有上面提到的工具。如果还是找不到，那么恭喜你，<code>resolv.conf</code> 已经完全掌控在你的手里，你想怎么改就直接改吧。<p>接下来将会教你如何禁用自动管理 <code>resolv.conf</code> 的各种程序。<h2 id=2-networkmanager>2. NetworkManager</h2><p><code>NetworkManager</code> 是最常见的自动配置网络和 DNS 的工具。比如在 Debian 和 Fedora 中它负责配置 <code>/etc/resolv.conf</code>。NetworkManager 可以和其他工具共存，即使禁用了所有其他管理 <code>resolv.conf</code> 的程序，<code>NetworkManager</code> 也会跳出来接管 <code>resolv.conf</code>。<p>可以将 NetworkManager 的主配置部分的选项 <code>dns</code> 设置为 <code>none</code> 来禁用其对 DNS 的管理功能：<pre class=language-bash data-lang=bash style=background-color:#2b303b;color:#c0c5ce;><code class=language-bash data-lang=bash><span style=color:#bf616a;>$</span><span> echo</span><span style=color:#bf616a;> -e </span><span>"</span><span style=color:#a3be8c;>[main]\ndns=none</span><span>" > /etc/NetworkManager/conf.d/no-dns.conf
</span><span style=color:#bf616a;>$</span><span> systemctl restart NetworkManager.service
</span><span style=color:#bf616a;>$</span><span> rm /etc/resolv.conf
</span></code></pre><p>如果配置完了以后没有生效，那么可能存在配置冲突（通常是由 <code>dnsmasq</code> 引起的），需要找到冲突的配置：<pre class=language-bash data-lang=bash style=background-color:#2b303b;color:#c0c5ce;><code class=language-bash data-lang=bash><span style=color:#bf616a;>$</span><span> grep</span><span style=color:#bf616a;> -ir </span><span>"</span><span style=color:#a3be8c;>\[main\]</span><span>" /etc/NetworkManager/
</span></code></pre><h2 id=3-netconfig>3. netconfig</h2><p>如果是 <code>openSUSE</code>，<code>SUSE</code> 或其他衍生发行版，一般都是由 <code>netconfig</code> 来控制 <code>resolv.conf</code>。可以通过禁用 <code>/etc/sysconfig/network/config</code> 中的 <code>NETCONFIG_DNS_POLICY</code> 选项来禁用其对 resolv.conf 的控制：<pre class=language-ini data-lang=ini style=background-color:#2b303b;color:#c0c5ce;><code class=language-ini data-lang=ini><span>NETCONFIG_DNS_POLICY=</span><span style=color:#a3be8c;>""
</span></code></pre><p>还要删除 <code>netconfig</code> 生成的 <code>resolv.conf</code> 文件，并重启系统：<pre class=language-bash data-lang=bash style=background-color:#2b303b;color:#c0c5ce;><code class=language-bash data-lang=bash><span style=color:#bf616a;>$</span><span> rm /etc/resolv.conf
</span><span style=color:#bf616a;>$</span><span> reboot
</span></code></pre><p>现在就可以手动创建 <code>/etc/resolv.conf</code> 文件随意修改了。<h2 id=4-resolvconf-he-rdnssd>4. resolvconf 和 rdnssd</h2><p>如果是 <code>Debian 8.0</code> 或 <code>Ubuntu 15.04</code>，并且启用了 <code>IPv6</code>，那么你可能会遇到 <a href=https://www.ctrl.blog/entry/how-to-debian-dns-resolv.html><code>resolvconf</code> 和 <code>rdnssd</code> 互相争夺 resolv.conf 控制器</a>的情况。两个服务都想控制这个文件，每隔几毫秒就会覆盖对方的配置，从而导致间歇性的 DNS 解析中断。可以直接禁用并立即停止这两个服务：<pre class=language-bash data-lang=bash style=background-color:#2b303b;color:#c0c5ce;><code class=language-bash data-lang=bash><span style=color:#bf616a;>$</span><span> systemctl disable</span><span style=color:#bf616a;> --now</span><span> resolvconf.service rdnssd.service
</span><span style=color:#bf616a;>$</span><span> rm /etc/resolv.conf
</span></code></pre><p>最后手动创建 <code>/etc/resolv.conf</code> 文件。<h2 id=5-systemd-resolved>5. systemd-resolved</h2><p>如果是 <code>Ubuntu 16.10</code> 或更新的版本，则由 <code>systemd-resolved</code> 服务来管理 DNS，可以使用下面的命令来禁用并立即停止该服务：<pre class=language-bash data-lang=bash style=background-color:#2b303b;color:#c0c5ce;><code class=language-bash data-lang=bash><span style=color:#bf616a;>$</span><span> systemctl disable</span><span style=color:#bf616a;> --now</span><span> systemd-resolved.service
</span><span style=color:#bf616a;>$</span><span> rm /etc/resolv.conf
</span></code></pre><p>然后手动创建 <code>/etc/resolv.conf</code> 文件。<h2 id=6-chuang-jian-etc-resolv-conf>6. 创建 /etc/resolv.conf</h2><p>最后的最后，就是手动创建 <code>/etc/resolv.conf</code> 文件了，建议权限设置为 <code>644</code>。配置示例：<pre class=language-ini data-lang=ini style=background-color:#2b303b;color:#c0c5ce;><code class=language-ini data-lang=ini><span style=color:#bf616a;>nameserver </span><span style=color:#d08770;>114.114.114.114
</span><span style=color:#bf616a;>nameserver </span><span style=color:#d08770;>223.5.5.5
</span></code></pre><p>当然，除了 nameserver 外，还有其他的参数可以配置，感兴趣可以 man 一下：<pre class=language-bash data-lang=bash style=background-color:#2b303b;color:#c0c5ce;><code class=language-bash data-lang=bash><span style=color:#bf616a;>$</span><span> man 5 resolv.conf
</span></code></pre></div></div></div><footer class=footer__poweredby><p class=caption>© 2022 All Rights Reserved modao::rustacean@aliyun.com<p class=caption>© Powered by <a href=https://www.getzola.org/>Zola</a><p class=caption>© Theme: <a href=https://github.com/pawroman/zola-theme-terminimal/>Terminimal</a> by pawroman<p class=caption><a href=https://creativecommons.org/licenses/by-nc-nd/4.0/deed.zh rel=license>自由转载-非商用-非衍生-保持署名</a></footer></div>