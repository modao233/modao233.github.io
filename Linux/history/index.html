<!doctype html><html lang=zh-Hans-CN><head><title>modao's blog</title><meta content="text/html; charset=utf-8" http-equiv=content-type><meta content="width=device-width,initial-scale=1.0,maximum-scale=1" name=viewport><meta content=noodp name=robots><link href=https://modao.site/style.css rel=stylesheet><link href=https://modao.site/color/green.css rel=stylesheet><link href=https://modao.site/color/background_dark.css rel=stylesheet><link href=https://modao.site/font-hack.css rel=stylesheet><body><div class=container><header class=header><div class=header__inner><div class=header__logo><a style="text-decoration: none;" href=https://modao.site> <div class=logo>MODAO</div> </a></div></div><nav class=menu><ul class=menu__inner><li class=active><a href=https://modao.site>Home</a><li><a href=https://modao.site/tags>Tags</a><li><a href=https://modao.site/links>Links</a><li><a href=https://modao.site/friend>Friend</a><li><a href=https://modao.site/about>About Me</a></ul></nav></header><div class=content><div class=post><h1 class=post-title><a href=https://modao.site/Linux/history/>history命令</a></h1><div class=post-meta-inline><span class=post-date> 2021-07-16 </span></div><span class=post-tags-inline> :: tags:  <a class=post-tag href=https://modao.site/tags/linux/>#Linux</a></span><div class=post-content><h1 id=historybu-bao-cun-ming-ling>history不保存命令</h1><p>bash和zsh默认会将输入过的命令保存在 <code>$HISTFILE</code> 文件中，保存的数量由 <code>$HISTSIZE</code> 决定。<p>通过对<code>$HISTCONTROL</code>设置，可以让history不保存一些命令：<ul><li>设置为 ignorespace：以空格开头的行将不会记录到history中<li>设置为 ignoredups：匹配上一次历史记录的行将不会被记录<li>设置为 ignoreboth：同时使用ignorespace和ignoredups的行为<li>如果没有定义，或者设置为其他值，所有解释器读取的行都将存入历史列表，但还要经过HISTIGNORE处理</ul><p>可以通过 <code>set -o history</code> 来临时禁止本次登陆session中的history功能<p>对于已经记录在history中的命令：<ul><li>可以使用 <code>history -c</code> 清空历史记录<li>可以使用 <code>history -d N</code> 删除第N条历史记录</ul><h1 id=zshde-history>zsh的history</h1><p>zsh中使用命令<code>history -i</code>即可查看命令执行的时间，<code>HISTTIMEFORMAT</code>变量只对bash有效，zsh的history文件默认存储时间戳（开始时间以Unix纪元表示，经过的秒数以秒为单位）。<p>bash的<code>HISTFILESIZE</code>变量在zsh中对应的是<code>SAVEHIST</code><p><code>$HISTFILE</code>变量为保存文件，由于未找如何修改保存时间戳格式，初步想法是在执行<code>history -i</code>命令前使用<code>export $HISTFILE=xxx</code>。<h1 id=dui-history-filezuo-xiang-ying-bao-zhang>对history file作相应保障</h1><p>https://www.cnblogs.com/weiji100/p/3964230.html https://blog.csdn.net/marklua/article/details/42396361<p>首先，锁定shell的历史文件本身，更改它的属性为末尾只添加：<code>chattr +a .bash_history</code>。这样一来，就不可能删除或更改文件中的数据，连用户都无法改变属性——只有root用户才能改变。<p>其次，确保历史变量设置合理、<strong>无法更改</strong>。这些历史变量包括最重要的<code>HISTFILE</code>、<code>HISTCOMMAND</code>和<code>HISTIGNORE</code>。要做到这一点，使用shell的<code>typeset</code>命令，带-r选项，这使得指定的变量拥有只读属性。良好的操作规范是使所有历史环境变量都变为只读，比如：<pre style=background-color:#2b303b;color:#c0c5ce;><code><span>export HISTCONTROL=""
</span><span>export HISTFILE=$HOME/.bash_history
</span><span>export HISTFILESIZE=2000
</span><span>export HISTIGNORE=""
</span><span>export HISTSIZE=1000
</span><span>export HISTTIMEFORMAT="%a %b %Y %T %z "
</span><span>typeset -r HISTCONTROL
</span><span>typeset -r HISTFILE
</span><span>typeset -r HISTFILESIZE
</span><span>typeset -r HISTIGNORE
</span><span>typeset -r HISTSIZE
</span><span>typeset -r HISTTIMEFORMAT
</span></code></pre><blockquote><p>HISTTIMEFORMAT是bash shell的扩展，将在历史文件中提供时间戳。</blockquote><p>对于bash shell来说，你需要更改历史的一些标准选项：<pre style=background-color:#2b303b;color:#c0c5ce;><code><span>#设置cmdhist将把多行命令放入到单单一个历史行
</span><span>shopt -s cmdhist
</span><span>#设置histappend将确保被添加到历史文件，而不是像通常的做法那样覆盖历史文件
</span><span>shopt -s histappend
</span></code></pre><p>对于bash shell来说，还要设置PROMPT_COMMAND：<pre style=background-color:#2b303b;color:#c0c5ce;><code><span>PROMPT_COMMAND="history -a" 
</span><span>typeset -r PROMPT_COMMAND
</span></code></pre><p>这是由于bash shell实际上把历史写入到内存中，<strong>历史文件仅在shell会话结束时加以更新</strong>。这个命令会把上一个命令附加到磁盘上的历史文件。<p>最后，<a href=http://blog.rootshell.be/2009/02/28/bash-history-to-syslog/><strong>创建一个SIGDEBUG陷阱</strong></a>，将命令发送到系统日志（syslog）。VMware的ESXi借助自己版本的ash shell已经具有这样的功能。简而言之，应创建一个把当前命令记入日志（从历史文件获取）的函数，然后用logger命令，把它发送到系统日志。这一步在bash shell和Korn Shell中都适用。 这些步骤有些冗长，不过在新版的bash和ksh中有一些新的功能特性，让这一切变得极其容易。GNU Bash在4.1版中添加了记入到系统日志中的功能，只需要编译shell的时候开启该功能即可激活。</div></div></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2022 modao</span><span class=copyright-theme> <span class=copyright-theme-sep>:: </span> Theme: <a href=https://github.com/pawroman/zola-theme-terminimal/>Terminimal</a> by pawroman </span></div></div></footer></div>